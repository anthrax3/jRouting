// Copyright 2012-2015 (c) Peter Å irka <petersirka@gmail.com>

"use strict";var LIMIT_HISTORY=100,LIMIT_HISTORY_ERROR=100,JRFU={},jRouting={version:101,routes:[],history:[],errors:[],events:{},eventsOnce:{},global:{},get:{},middlewares:{},repository:{},url:"",model:null,isFirst:!0,isReady:!1,isRefresh:!1,isSkip:!1,isModernBrowser:"undefined"!=typeof history.pushState,count:0};jRouting.on=function(t,n){var r=this,e=r.events[t];return e?(e.push(n),r):(r.events[t]=[n],r)},jRouting.once=function(t,n){var r=this,e=r.eventsOnce[t];return e?(e.push(n),r):(r.eventsOnce[t]=[n],r)},jRouting.emit=function(t){var n=this,r=n.events[t]||[],e=n.eventsOnce[t]||[],i=r.length,o=e.length;if(0===i&&0===o)return n;for(var a=[],u=arguments.length,s=1;u>s;s++)a.push(arguments[s]);if(i>0)for(var s=0;i>s;s++)r[s].apply(n,a);if(o>0){for(var s=0;i>s;s++)e[s].apply(n,a);delete n.eventsOnce[t]}},jRouting.route=function(t,n,r,e){var i;if(n instanceof Array){var i=r;r=n,n=i}var o=this,a=t.count("/")+(-1===t.indexOf("*")?0:10),u=o._route(t.trim()),s=[];if("boolean"==typeof r&&(i=e,e=r,r=i),"string"==typeof r&&(r=r.split(",")),-1!==t.indexOf("{")){for(var h=0;h<u.length;h++)"{"===u[h].substring(0,1)&&s.push(h);a-=s.length}return o.routes.push({url:u,fn:n,priority:a,params:s,middleware:r||null,once:e,count:0}),o.routes.sort(function(t,n){return t.priority>n.priority?-1:t.priority<n.priority?1:0}),o},jRouting.middleware=function(t,n){var r=this;return r.middlewares[t]=n,r},jRouting.refresh=function(){var t=this;return t.location(t,!0)},jRouting._route=function(t){t=t.toLowerCase(),"/"===t.charIndex(0)&&(t=t.substring(1)),"/"===t.charIndex(t.length-1)&&(t=t.substring(0,t.length-1));var n=t.split("/");return 1===n.length&&""===n[0]&&(n[0]="/"),n},jRouting._route_param=function(t,n){var r=[];if(!n||!t)return r;var e=n.params.length;if(0===e)return r;for(var i=0;e>i;i++){var o=t[n.params[i]];r.push("/"===o?"":o)}return r},jRouting._route_compare=function(t,n){var r=t.length,e=1===r&&"/"===t[0];if(n.length!==r)return!1;for(var i=0;r>i;i++){var o=n[i];if("undefined"==typeof o)return!1;if(e||"{"!==o.charIndex(0)){if("*"===o)return!0;if(t[i]!==o)return!1}}return!0},jRouting.location=function(t,n){var r=t.indexOf("?");-1!==r&&(t=t.substring(0,r)),t=JRFU.prepareUrl(t),t=JRFU.path(t);var e=this,i=e._route(t),o=[],a=!0;e.isRefresh=n||!1,e.count++,n||e.url.length>0&&e.history[e.history.length-1]!==e.url&&(e.history.push(e.url),e.history.length>LIMIT_HISTORY&&e.history.shift());for(var u=e.routes.length,s=0;u>s;s++){var h=e.routes[s];e._route_compare(i,h.url)&&(-1===h.url.indexOf("*")&&(a=!1),h.once&&h.count>0||(h.count++,o.push(h)))}var f=!1,l=[];e.url=t,e.repository={},e._params(),e.emit("location",t),u=o.length;for(var s=0;u>s;s++){var h=o[s];h.middleware&&0!==h.middleware.length?!function(t){for(var n=t.middleware.length,r=[],o=0;n>o;o++)!function(t,n){r.push(function(r){n.call(e,r,t)})}(t,jRouting.middlewares[t.middleware[o]]);r.async(function(){t.fn.apply(e,e._route_param(i,t))})}(h):h.fn.apply(e,e._route_param(i,h))}f&&e.status(500,l),a&&e.status(404,new Error("Route not found."))},jRouting.back=function(){var t=this,n=t.history.pop()||"/";return t.url="",t.redirect(n,!0),t},jRouting.status=function(t,n){var r=this;return r.emit("status",t||404,n),r},jRouting.redirect=function(t,n){var r=this;return r.isModernBrowser?(r.isSkip=!0,history.pushState(null,null,t),r.model=n||null,r.location(t,!1),r):(window.location.href="#!"+JRFU.path(t),r.model=n||null,r)},jRouting.cookie={read:function(t){for(var n=document.cookie.split(";"),r=0;r<n.length;r++){var e=n[r];" "===e.charAt(0)&&(e=e.substring(1));var i=e.split("=");if(i.length>1&&i[0]===t)return i[1]}return""},write:function(t,n,r){var e="";if("number"==typeof r){var i=new Date;i.setTime(i.getTime()+24*r*60*60*1e3),e="; expires="+i.toGMTString()}else r instanceof Date&&(e="; expires="+r.toGMTString());document.cookie=t+"="+n+e+"; path=/"},remove:function(t){this.write(t,"",-1)}},jRouting._params=function(){for(var t=this,n={},r=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),e=0;e<r.length;e++){var i=r[e].split("=");if(2===i.length){var o=decodeURIComponent(i[0]),a=decodeURIComponent(i[1]),u=n[o]instanceof Array;"undefined"==typeof n[o]||u||(n[o]=[n[o]]),u?n[o].push(a):n[o]=a}}return t.get=n,t},JRFU.path=function(t,n){"undefined"==typeof n&&(n="/");var r=t.indexOf("?"),e="";-1!==r&&(e=t.substring(r),t=t.substring(0,r));var i=t.charIndex(t.length-1);return i!==n&&(t+=n),t+e},Array.prototype.forEach||(Array.prototype.forEach=function(t){for(var n=this,r=0;r<n.length;r++)t(n[r],r);return n}),Array.prototype.indexOf||(Array.prototype.indexOf=function(t){for(var n=this,r=0;r<n.length;r++)if(t===n[r])return r;return-1}),$(window).bind("popstate",function(){if(1===jRouting.count||jRouting.isSkip)return void(jRouting.isSkip=!1);var t=window.location.hash||"";0===t.length&&(t=window.location.pathname),jRouting.location(JRFU.path(t))}),$(window).bind("hashchange",function(){if(jRouting.isReady){var t=window.location.hash||"";0===t.length&&(t=window.location.pathname),jRouting.location(JRFU.path(t))}}),null!==navigator.appVersion.match(/MSIE.7|MSIE.8/)&&setInterval(function(){if(jRouting.isReady){var t=window.location.hash||"";0===t.length&&(t=window.location.pathname),t=JRFU.path(t),t!==jRouting.url&&jRouting.location(t)}},500),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s]+|[\s]+$/g,"")}),String.prototype.count||(String.prototype.count=function(t){var n=0,r=0;do n=this.indexOf(t,n+t.length),n>0&&r++;while(n>0);return r}),String.prototype.charIndex||(String.prototype.charIndex=function(t){return this.toString().substring(t,t+1)}),JRFU.path=function(t,n){"undefined"==typeof n&&(n="/");var r=t.indexOf("?"),e="";-1!==r&&(e=t.substring(r),t=t.substring(0,r));var i=t.charIndex(t.length-1);return i!==n&&(t+=n),t+e},JRFU.prepareUrl=function(t){var n=t.indexOf("#!");return-1!==n?t.substring(n+2):t},Array.prototype.async||(Array.prototype.async=function(t){var n=this,r=n.shift();return void 0===r?(t&&t(),n):(r(function(){setTimeout(function(){n.async(t)},1)}),n)}),jRouting.on("error",function(t,n,r){var e=this;e.errors.push({error:t,url:n,name:r,date:new Date}),e.errors.length>LIMIT_HISTORY_ERROR&&e.errors.shift()}),$.fn.jRouting=function(){var t=function(t){t.preventDefault(),jRouting.redirect($(this).attr("href"))};return this.filter("a").bind("click",t),this},$(document).ready(function(){var t=window.location.hash||"";if(0===t.length&&(t=window.location.pathname),jRouting.isReady=!0,"undefined"==typeof jRouting.events.ready)jRouting.location(JRFU.path(JRFU.prepareUrl(t)));else{var n=JRFU.path(JRFU.prepareUrl(t));jRouting.emit("ready",n),jRouting.emit("load",n)}});