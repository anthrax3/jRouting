var JRFU={},jRouting={LIMIT_HISTORY:100,LIMIT_HISTORY_ERROR:100,version:"v1.1.0",cache:{},routes:[],history:[],errors:[],events:{},eventsOnce:{},global:{},query:{},params:[],middlewares:{},repository:{},url:"",model:null,isFirst:!0,isReady:!1,isRefresh:!1,isModernBrowser:"undefined"!=typeof history.pushState,count:0};jRouting.on=function(name,fn){var self=this,e=self.events[name];return e?(e.push(fn),self):(self.events[name]=[fn],self)},jRouting.once=function(name,fn){var self=this,e=self.eventsOnce[name];return e?(e.push(fn),self):(self.eventsOnce[name]=[fn],self)},jRouting.emit=function(name){var self=this,events=self.events[name]||[],eventsOnce=self.eventsOnce[name]||[],length=events.length,lengthOnce=eventsOnce.length;if(!length&&!lengthOnce)return self;for(var params=[],tmp=arguments.length,i=1;tmp>i;i++)params.push(arguments[i]);if(length>0)for(var i=0;length>i;i++)events[i].apply(self,params);if(lengthOnce){for(var i=0;length>i;i++)eventsOnce[i].apply(self,params);delete self.eventsOnce[name]}},jRouting.route=function(url,fn,middleware,init){var tmp;if(fn instanceof Array){var tmp=middleware;middleware=fn,fn=tmp}"function"==typeof middleware&&(tmp=init,init=middleware,middleware=tmp);var self=this,priority=url.count("/")+(-1===url.indexOf("*")?0:10),route=self._route(url.trim()),params=[];if("string"==typeof middleware&&(middleware=middleware.split(",")),-1!==url.indexOf("{")){priority-=100;for(var i=0;i<route.length;i++)"{"===route[i].substring(0,1)&&params.push(i);priority-=params.length}return self.routes.push({url:route,fn:fn,priority:priority,params:params,middleware:middleware||null,init:init,count:0,pending:!1}),self.routes.sort(function(a,b){return a.priority>b.priority?-1:a.priority<b.priority?1:0}),self},jRouting.middleware=function(name,fn){var self=this;return self.middlewares[name]=fn,self},jRouting.refresh=function(){var self=this;return self.location(self.url,!0)},jRouting.reload=function(){return jRouting.refresh()},jRouting._route=function(url){"/"===url.charIndex(0)&&(url=url.substring(1)),"/"===url.charIndex(url.length-1)&&(url=url.substring(0,url.length-1));var arr=url.split("/");return 1===arr.length&&""===arr[0]&&(arr[0]="/"),arr},jRouting._route_param=function(routeUrl,route){var arr=[];if(!route||!routeUrl)return arr;var length=route.params.length;if(!length)return arr;for(var i=0;length>i;i++){var value=routeUrl[route.params[i]];arr.push("/"===value?"":value)}return arr},jRouting._route_compare=function(url,route){var length=url.length,skip=1===length&&"/"===url[0];if(route.length!==length)return!1;for(var i=0;length>i;i++){var value=route[i];if("undefined"==typeof value)return!1;if(skip||"{"!==value.charIndex(0)){if("*"===value)return!0;if(url[i]!==value)return!1}}return!0},jRouting.location=function(url,isRefresh){if(jRouting.isReady){var index=url.indexOf("?");-1!==index&&(url=url.substring(0,index)),url=JRFU.prepareUrl(url),url=JRFU.path(url);var self=this,path=self._route(url),routes=[],notfound=!0,raw=[];raw.push.apply(raw,path);for(var i=0,length=path.length;length>i;i++)path[i]=path[i].toLowerCase();self.isRefresh=isRefresh||!1,self.count++,isRefresh||self.url.length&&self.history[self.history.length-1]!==self.url&&(self.history.push(self.url),self.history.length>self.LIMIT_HISTORY&&self.history.shift());for(var length=self.routes.length,i=0;length>i;i++){var route=self.routes[i];if(self._route_compare(path,route.url)&&(-1===route.url.indexOf("*")&&(notfound=!1),!(route.once&&route.count>0))){route.count++,routes.push(route);break}}var isError=!1,error=[];self.url.length>0&&(self.cache[self.url]=self.repository),self.url=url,self.repository=self.cache[url],void 0===self.repository&&(self.repository={}),self._params(),self.params=self._route_param(raw,route),self.emit("location",url),length=routes.length;for(var i=0;length>i;i++){var route=routes[i];if(!route.pending)if(route.middleware&&0!==route.middleware.length)!function(route){for(var l=route.middleware.length,middleware=[],j=0;l>j;j++)!function(route,fn){middleware.push(function(next){fn.call(self,next,route)})}(route,jRouting.middlewares[route.middleware[j]]);return route.init?(route.pending=!0,route.init(function(){middleware.middleware(function(){route.fn.apply(self,self.params),route.pending=!1})}),void(route.init=null)):(route.pending=!0,void middleware.middleware(function(){route.fn.apply(self,self.params),route.pending=!1}))}(route);else{if(!route.init){route.fn.apply(self,self.params);continue}route.pending=!0,function(route){route.init(function(){route.fn.apply(self,self.params),route.pending=!1})}(route),route.init=null}}isError&&self.status(500,error),notfound&&self.status(404,new Error("Route not found."))}},jRouting.prev=function(){var self=this;return self.history[self.history.length-1]},jRouting.back=function(){var self=this,url=self.history.pop()||"/";return self.url="",self.redirect(url,!0),self},jRouting.status=function(code,message){var self=this;return self.emit("status",code||404,message),self},jRouting.redirect=function(url,model){var self=this;return self.isModernBrowser?(history.pushState(null,null,url),self.model=model||null,self.location(url,!1),self):(location.href=url,!1)},jRouting.cookie={read:function(name){for(var arr=document.cookie.split(";"),i=0;i<arr.length;i++){var c=arr[i];" "===c.charAt(0)&&(c=c.substring(1));var v=c.split("=");if(v.length>1&&v[0]===name)return v[1]}return""},write:function(name,value,expire){var expires="";if("number"==typeof expire){var date=new Date;date.setTime(date.getTime()+24*expire*60*60*1e3),expires="; expires="+date.toGMTString()}else expire instanceof Date&&(expires="; expires="+expire.toGMTString());document.cookie=name+"="+value+expires+"; path=/"},remove:function(name){this.write(name,"",-1)}},jRouting._params=function(){for(var self=this,data={},params=location.href.slice(location.href.indexOf("?")+1).split("&"),i=0;i<params.length;i++){var param=params[i].split("=");if(2===param.length){var name=decodeURIComponent(param[0]),value=decodeURIComponent(param[1]),isArray=data[name]instanceof Array;"undefined"==typeof data[name]||isArray||(data[name]=[data[name]]),isArray?data[name].push(value):data[name]=value}}return self.query=data,self},JRFU.path=function(url,d){"undefined"==typeof d&&(d="/");var index=url.indexOf("?"),params="";-1!==index&&(params=url.substring(index),url=url.substring(0,index));var c=url.charIndex(url.length-1);return c!==d&&(url+=d),url+params},String.prototype.count||(String.prototype.count=function(text){var index=0,count=0;do index=this.indexOf(text,index+text.length),index>0&&count++;while(index>0);return count}),String.prototype.charIndex||(String.prototype.charIndex=function(index){return this.toString().substring(index,index+1)}),jRouting.path=JRFU.path=function(url,d){"undefined"==typeof d&&(d="/");var index=url.indexOf("?"),params="";-1!==index&&(params=url.substring(index),url=url.substring(0,index));var c=url.charIndex(url.length-1);return c!==d&&(url+=d),url+params},JRFU.prepareUrl=function(url){return index=url.indexOf("#"),-1!==index?url.substring(0,index):url},Array.prototype.middleware||(Array.prototype.middleware=function(callback){var self=this,item=self.shift();return void 0===item?(callback&&callback(),self):(item(function(){setTimeout(function(){self.middleware(callback)},1)}),self)}),jRouting.on("error",function(err,url,name){var self=this;self.errors.push({error:err,url:url,name:name,date:new Date}),self.errors.length>self.LIMIT_HISTORY_ERROR&&self.errors.shift()}),$.fn.jRouting=function(g){if(!jRouting.isModernBrowser)return this;var handler=function(e){e.preventDefault(),jRouting.redirect($(this).attr("href"))};return g?($(document).on("click",this.selector,handler),this):(this.filter("a").bind("click",handler),this)},$(document).ready(function(){var url=location.pathname;jRouting.url=JRFU.path(JRFU.prepareUrl(url)),jRouting.events.ready?(jRouting.emit("ready",jRouting.url),jRouting.emit("load",jRouting.url)):setTimeout(function(){jRouting.isReady=!0,jRouting.location(jRouting.url),jRouting.emit("ready",jRouting.url),jRouting.emit("load",jRouting.url)},5),$(window).on("popstate",function(){if(jRouting.isReady){var url=location.hash||"";0===url.length&&(url=location.pathname),jRouting.location(JRFU.path(url))}})});